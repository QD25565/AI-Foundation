# V2-Daemon Auto-Start Setup Script
# Run this once to enable auto-start on Windows boot
#
# Usage: Right-click -> Run with PowerShell
# Or: powershell -ExecutionPolicy Bypass -File setup-autostart.ps1
#
# To remove auto-start: .\setup-autostart.ps1 -Uninstall

param(
    [switch]$Uninstall,
    [string]$DaemonPath = "$env:USERPROFILE\.ai-foundation\bin\v2-daemon.exe"
)

$StartupFolder = "$env:APPDATA\Microsoft\Windows\Start Menu\Programs\Startup"
$VbsPath = "$StartupFolder\ai-foundation-v2-daemon.vbs"

if ($Uninstall) {
    Write-Host "Removing V2-Daemon auto-start..." -ForegroundColor Yellow
    if (Test-Path $VbsPath) {
        Remove-Item $VbsPath -Force
        Write-Host "Auto-start removed." -ForegroundColor Green
    } else {
        Write-Host "Auto-start was not configured." -ForegroundColor Yellow
    }
    exit 0
}

# Check if daemon exists
if (-not (Test-Path $DaemonPath)) {
    Write-Host "ERROR: v2-daemon.exe not found at: $DaemonPath" -ForegroundColor Red
    Write-Host ""
    Write-Host "Please either:" -ForegroundColor Yellow
    Write-Host "  1. Build it: cargo build --release --bin v2-daemon"
    Write-Host "  2. Copy it to: $DaemonPath"
    Write-Host "  3. Specify path: .\setup-autostart.ps1 -DaemonPath 'C:\path\to\v2-daemon.exe'"
    exit 1
}

# Create the VBS launcher script (launches hidden, no console window)
$EscapedPath = $DaemonPath -replace '\\', '\\'
$VbsContent = @"
' AI-Foundation V2-Daemon Auto-Start
' Launches daemon hidden (no console window)
' Generated by setup-autostart.ps1

Set WshShell = CreateObject("WScript.Shell")
WshShell.Run "$EscapedPath", 0, False

' Parameters:
'   0 = Hidden window (no console)
'   False = Don't wait for completion (run in background)
"@

# Write to Startup folder
Set-Content -Path $VbsPath -Value $VbsContent -Encoding ASCII

Write-Host ""
Write-Host "=== V2-Daemon Auto-Start Enabled ===" -ForegroundColor Green
Write-Host ""
Write-Host "  Daemon: $DaemonPath"
Write-Host "  Startup: $VbsPath"
Write-Host ""
Write-Host "The daemon will now start automatically (hidden) when Windows boots."
Write-Host ""
Write-Host "To remove auto-start:" -ForegroundColor Cyan
Write-Host "  .\setup-autostart.ps1 -Uninstall"
Write-Host ""

# Offer to start now if not running
$running = Get-Process -Name "v2-daemon" -ErrorAction SilentlyContinue
if (-not $running) {
    $start = Read-Host "Daemon not currently running. Start now? (Y/n)"
    if ($start -ne 'n' -and $start -ne 'N') {
        Start-Process $DaemonPath -WindowStyle Hidden
        Start-Sleep -Seconds 1
        $check = Get-Process -Name "v2-daemon" -ErrorAction SilentlyContinue
        if ($check) {
            Write-Host "Daemon started! (PID: $($check.Id))" -ForegroundColor Green
        } else {
            Write-Host "Daemon may have failed to start. Check logs." -ForegroundColor Yellow
        }
    }
} else {
    Write-Host "Daemon already running (PID: $($running.Id))" -ForegroundColor Cyan
}
